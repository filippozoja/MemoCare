<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Modifica Attivit√†</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    body {
      padding: 0%;
    }
    .nav-back {
      position: absolute;
      top: 0px;
      left: 0px;
      background: transparent;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .sun-icon{
      padding:0%;
    }
    .nav-back:focus {
      outline: none;
    }
    .back-button {
      display: inline-block;
      margin: 0px 0 0 0px;
      background: transparent;
      border: none;
      font-size: 1rem;
      color: black;
      cursor: pointer;
    }
    .back-button:hover {
      text-decoration: underline;
    }
    .back-button-page {
      background-color: var(--primary-color);
      border: none;
      color: white;
      padding: 10px;
      font-size: 1.1rem;
      border-radius: 12px;
      cursor: pointer;
      display: block;
      width: 100%;
      margin: 16px auto 0 auto; /* center below panel */
      text-align: center;
    }
    .pager {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 16px;
      gap: 8px;
      width: 100%;
    }
    .dot {
      height: 12px;
      width: 12px;
      margin: 0 2px;
      background-color: #bbb;
      border-radius: 50%;
      display: inline-block;
      cursor: pointer;
    }
    .dot.active {
      background-color: #2f76f6;
    }
    .field {
      margin-top: 10px;
    }
    label {
      display: block;
      font-weight: bold;
      font-size: .8em;
      margin-bottom: 5px;
    }
    input[type="text"], textarea {
      width: 100%;
      margin: 0px 100px 0px 0px;
      padding: 5px 0px 5px 10px;
      box-sizing: border-box;
      border-radius: 12px;
      border: .5px solid #ccc;
    }
    select{
      width: 100%;
      margin: 0px 100px 0px 0px;
      padding: 10px;
      box-sizing: border-box;
      border-radius: 12px;
      border: .5px solid #a19f9f;
    }
    .save {
      background-color: #2f76f6;
      border: none;
      color: white;
      padding: 10px;
      font-size: 1.1rem;
      border-radius: 12px;
      cursor: pointer;
      display: block;
      width: 100%;
      margin: 16px auto 0 auto; /* center below panel */
      text-align: center;
    }
    .panel {
      background-color: #BDE0FE;
      border-radius: 25px;
      padding: 20px 30px 20px 30px;
    }
    .panel .field {
      background-color: white;
      border-radius: 20px;
      padding: 4px 10px 10px 10px;
      margin-bottom: 10px;
    }
    .panel .field:last-of-type {
      margin-bottom: 0px;
    }
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
    }
    .page{
      padding-top: 30px;
      width: 100%;
    }
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 30px;
      margin-top: 16px;
    }
    .nav-buttons button {
      flex: 0 0 45%;
    }
  </style>
</head>
<body>
  <script>
  // Se non esiste username in localStorage, reindirizza a index.html
  if (!localStorage.getItem('username')) {
    window.location.replace('index.html');
  }
  </script>
  <div class="header">
    <a href="profilo.html">
      <img src="icon/icon-sun.png" alt="Icona Sole" class="sun-icon"/>
    </a>
  </div>
  <div class="profile">
    <form id="modificaAttivitaForm">
      <div class="page page-1">
        <div class="panel">
          <p id="fasciaTitolo" style="font-weight:600; font-size:1rem; margin-bottom:16px;"></p>
          <div class="field">
            <label for="attivita">Attivit√†:</label>
            <input type="text" id="attivita" name="attivita" />
          </div>
          <div class="field">
            <label for="dove">Dove:</label>
            <input type="text" id="dove" name="dove" />
          </div>
          <div class="field">
            <label for="conchi">Con chi:</label>
            <input type="text" id="conchi" name="conchi" />
          </div>
        </div>
        <div class="nav-buttons">
          <button type="button" class="back-button-page" onclick="history.back()">‚Üê Indietro</button>
          <button type="button" id="nextBtn" class="save">Avanti ‚Üí</button>
        </div>
        <div class="pager">
          <span id="dot1" class="dot active"></span>
          <span id="dot2" class="dot"></span>
        </div>
      </div>
      <div class="page page-2" style="display: none;">
        <div class="panel">
          <table class="field-table" style="width:100%; border-collapse:separate; border-spacing:0 16px;">
            <tr>
              <td class="label-cell" style="padding-right:16px; vertical-align:top; width:30%;"><label for="tema">Tema:</label></td>
              <td class="input-cell"><select id="tema" name="tema">
                    <option value="">Tema</option>
                    <option value="igiene">Igiene</option>
                    <option value="pasto">Pasto</option>
                    <option value="uscita">Uscita</option>
                    <option value="passatempo">Passatempo</option>
                  </select></td>
            </tr>
            <tr>
              <td class="label-cell"><label for="icona">Icona:</label></td>
              <td class="input-cell"><select id="icona" name="icona">
                    <option value="">Icona</option>
                    <option value="ü´ß">ü´ß</option>
                    <option value="üç¥">üç¥</option>
                    <option value="üö∂üèª">üö∂üèª</option>
                    <option value="üß©">üß©</option>
                  </select></td>
            </tr>
            <tr>
              <td class="label-cell"><label for="orario_inizio">Orario d‚Äôinizio:</label></td>
              <td class="input-cell"><select id="orario_inizio" name="orario_inizio">
                    <option value="">--</option>
                    <!-- ore 6-23 -->
                    <script>
                      for(let h=6; h<=23; h++){
                        document.write(`<option value="${h.toString().padStart(2,'0')}:00">${h.toString().padStart(2,'0')}:00</option>`);
                      }
                    </script>
                  </select></td>
            </tr>
            <tr>
              <td class="label-cell"><label for="durata2">Durata:</label></td>
              <td class="input-cell"><select id="durata2" name="durata2">
                    <option value="">Durata</option>
                    <option value="10">10 min</option>
                    <option value="15">15 min</option>
                    <option value="20">20 min</option>
                    <option value="30">30 min</option>
                    <option value="40">40 min</option>
                    <option value="50">50 min</option>
                    <option value="60">1 ora</option>
                    <option value="75">1h 15min</option>
                    <option value="90">1h 30min</option>
                    <option value="105">1h 45min</option>
                    <option value="120">2h</option>
                    <option value="150">2h 30min</option>
                  </select></td>
            </tr>
            <tr>
              <td class="label-cell"><label for="preavviso2">Preavviso:</label></td>
              <td class="input-cell"><select id="preavviso2" name="preavviso2">
                    <option value="">Preavviso</option>
                    <option value="0">0 min</option>
                    <option value="5">5 min</option>
                    <option value="10">10 min</option>
                    <option value="15">15 min</option>
                    <option value="20">20 min</option>
                    <option value="25">25 min</option>
                    <option value="30">30 min</option>
                    <option value="35">35 min</option>
                    <option value="40">40 min</option>
                    <option value="45">45 min</option>
                    <option value="50">50 min</option>
                    <option value="55">55 min</option>
                    <option value="60">60 min</option>
                  </select></td>
            </tr>
          </table>
        </div>
        <div class="nav-buttons">
          <button type="button" id="prevBtn" class="back-button-page">‚Üê Indietro</button>
          <button type="button" class="save" onclick="handleSave()">Salva</button>
        </div>
        <div class="pager">
          <span id="dot1" class="dot"></span>
          <span id="dot2" class="dot active"></span>
        </div>
      </div>
    </form>
  </div>
  <div id="toast" style="
       display: none;
       position: fixed;
       bottom: 20px;
       left: 50%;
       transform: translateX(-50%);
       background-color: rgba(0,0,0,0.8);
       color: white;
       padding: 12px 20px;
       border-radius: 20px;
       font-size: 1rem;
       z-index: 1000;
     "></div>
  <script>
    // Parametri e ranges
    const params = new URLSearchParams(location.search);
    const slot = parseInt(params.get('slot')) || 1;
    const ranges = {1:'5 alle 8',2:'8 alle 11',3:'11 alle 14',4:'14 alle 17',5:'17 alle 19',6:'19 alle 23'};
    const hourRanges = {1:[5,8],2:[8,11],3:[11,14],4:[14,17],5:[17,19],6:[19,23]};
    document.getElementById('fasciaTitolo').textContent = `Fascia oraria: dalle ${ranges[slot]}`;
    // Popola orari e filtra
    const orSel = document.getElementById('orario_inizio');
    for(let h=hourRanges[slot][0]; h<=hourRanges[slot][1]; h++){
      const val = h.toString().padStart(2,'0')+':00';
      orSel.insertAdjacentHTML('beforeend', `<option value="${val}">${val}</option>`);
    }
    // Gestione pagine
    const p1 = document.querySelector('.page-1'), p2 = document.querySelector('.page-2');
    const d1 = document.querySelectorAll('#dot1')[0], d2 = document.querySelectorAll('#dot2')[1];
    document.getElementById('nextBtn').onclick = ()=>{
      p1.style.display='none'; p2.style.display='block';
      d1.classList.remove('active'); d2.classList.add('active');
    };
    document.getElementById('prevBtn').onclick = ()=>{
      p2.style.display='none'; p1.style.display='block';
      d2.classList.remove('active'); d1.classList.add('active');
    };
    // Swipe (opzionale)
    let x0=null; document.querySelector('.container')
      .addEventListener('touchstart',e=>x0=e.changedTouches[0].screenX)
      .addEventListener('touchend',e=>{
        if(x0===null)return; const diff=x0-e.changedTouches[0].screenX;
        if(diff>50) document.getElementById('nextBtn').click();
        if(diff< -50) document.getElementById('prevBtn').click();
        x0=null;
      });
    // Salvataggio
    async function handleSave(){
      const data = {
        username: localStorage.username||'',
        slot, attivita:document.getElementById('attivita').value,
        dove:document.getElementById('dove').value,
        conchi:document.getElementById('conchi').value,
        tema:document.getElementById('tema').value,
        icona:document.getElementById('icona').value,
        orario_inizio:document.getElementById('orario_inizio').value,
        durata:parseInt(document.getElementById('durata2').value)||0,
        preavviso:parseInt(document.getElementById('preavviso2').value)||0
      };
      const resp = await fetch('php/post_attivita.php',{
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body:JSON.stringify(data)
      });
      const j=await resp.json();
      console.log('post_attivita response:', j);
      if (j.status === 'ok' || j.status === 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = 'Attivit√† inserita';
        toast.style.display = 'block';
        // After 1.5 seconds, redirect
        setTimeout(() => {
          window.location.href = 'aggiorna_card.html';
        }, 1500);
      } else {
        const toast = document.getElementById('toast');
        toast.textContent = 'Errore: ' + (j.msg || '');
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 1000);
      }
    }
  </script>
</body>
</html>
